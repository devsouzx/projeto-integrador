<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamentos - Sistema de Sa√∫de</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primaria: #9b59b6;
      --secundaria: #8e44ad;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background: rgba(214, 174, 241, 0.15);
      color: #333333;
    }
    
    .navegacao-superior {
      background: linear-gradient(90deg, var(--primaria), var(--secundaria));
      color: white;
      padding: 0.75rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .container-navegacao {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .logo {
      font-weight: 600;
      font-size: 1.25rem;
    }
    
    .menu-navegacao {
      display: flex;
      list-style: none;
    }
    
    .item-navegacao {
      margin-left: 1rem;
    }
    
    .link-navegacao {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: background-color 0.3s;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .link-navegacao:hover, .link-navegacao.ativo {
      background-color: rgba(255,255,255,0.2);
    }
    
     .info-usuario {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      position: relative;
    }

    .info-usuario:hover .menu-usuario {
      display: block;
    }

    .menu-usuario {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-width: 200px;
      z-index: 10;
    }

    .menu-usuario a {
      display: block;
      padding: 0.75rem 1rem;
      color: #333333;
      text-decoration: none;
      transition: background-color 0.2s;
    }

    .menu-usuario a:hover {
      background-color: #f5f5f5;
      color: var(--primaria);
    }

    .menu-usuario a i {
      margin-right: 0.5rem;
      width: 20px;
      text-align: center;
    }

    .avatar-usuario {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
      background-color: #f0e5f5;
    }
    
    .conteudo-principal {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }
    
    .cabecalho {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .titulo-pagina {
      font-size: 1.75rem;
      color: var(--primaria);
    }
    
    .sino-notificacao {
      position: relative;
      font-size: 1.25rem;
      color: var(--primaria);
    }
    
    .badge-notificacao {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #f8d7da;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .grade-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .card {
      background-color: white;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .cabecalho-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .titulo-card {
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .icone-card {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .icone-primaria {
      background-color: var(--primaria);
    }
    
    .icone-secundaria {
      background-color: var(--secundaria);
    }
    
    .icone-alerta {
      background-color: #fff3cd;
    }
    
    .lista-exames {
      list-style: none;
    }
    
    .item-exame {
      padding: 0.75rem 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .item-exame:ultimo {
      border-bottom: none;
    }
    
    .data-exame {
      font-size: 0.85rem;
      color: #666;
    }
    
    .status-exame {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-pendente {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .status-concluido {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status-perigo {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .botao {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.3s;
    }
    
    .botao-primaria {
      background-color: var(--primaria);
      color: white;
    }
    
    .botao-primaria:hover {
      background-color: #7d3c98;
      transform: translateY(-2px);
    }
    
    .botao-bloco {
      display: block;
      width: 100%;
      text-align: center;
    }
    
    .secao-informacao {
      background-color: white;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .grade-informacao {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .card-informacao {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
    }
    
    .card-informacao h3 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: var(--primaria);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .card-informacao p {
      font-size: 0.9rem;
    }
    
    .container-calendario {
      background-color: white;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }

    .cabecalho-calendario {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .navegacao-calendario button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      color: var(--primaria);
    }

    .grade-calendario {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .dia-calendario {
      padding: 1rem;
      text-align: center;
      border-radius: 6px;
      background-color: #f8f9fa;
    }

    .dia-calendario.cabecalho {
      background-color: var(--primaria);
      color: white;
      font-weight: 500;
    }
    
    .lista-agendamentos {
      background-color: white;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .item-agendamento {
      padding: 1rem;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .acoes-agendamento {
      display: flex;
      gap: 0.5rem;
    }

    .badge {
      padding: 0.25rem 0.5rem;
      border-radius: 20px;
      font-size: 0.85rem;
    }

    .badge-sucesso {
      background-color: #d4edda;
      color: #155724;
    }

    .badge-alerta {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 200;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }

    .conteudo-modal {
      background-color: #fff;
      margin: 10% auto;
      padding: 2rem;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      position: relative;
    }

    .fechar {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #888;
    }

    .fechar:hover {
      color: #333;
    }

    .grupo-formulario {
      margin-bottom: 1rem;
    }

    .controle-formulario {
      width: 100%;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    .linha-formulario {
      display: flex;
      gap: 1rem;
    }

    .linha-formulario .grupo-formulario {
      flex: 1;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .navegacao-superior {
        padding: 0.5rem;
      }

      .container-navegacao {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }
      
      .logo {
        font-size: 1rem;
        white-space: nowrap;
        margin-right: 0.5rem;
      }
      
      .menu-navegacao {
        flex-direction: row;
        overflow-x: auto;
        white-space: nowrap;
        gap: 0.25rem;
        width: 100%;
        scrollbar-width: thin;
        padding-bottom: 0.5rem;
      }

      .item-navegacao {
        margin-left: 0;
        flex: 0 0 auto;
      }
      
      .info-usuario {
        justify-content: center;
        margin-top: 0.5rem;
      }
      
      .grade-cards {
        grid-template-columns: 1fr;
      }
      
      .conteudo-principal {
        padding: 0 1rem;
      }
      
      .cabecalho {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .grade-calendario {
        grid-template-columns: repeat(7, minmax(30px, 1fr));
      }
      
      .dia-calendario {
        padding: 0.5rem;
        font-size: 0.8rem;
      }
      
      .item-agendamento {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .acoes-agendamento {
        align-self: flex-end;
      }
    }

    @media (max-width: 480px) {
      .linha-formulario {
        flex-direction: column;
        gap: 0;
      }
      
      .conteudo-modal {
        margin: 20% auto;
        padding: 1.5rem;
      }
    }

    .botao-secundaria {
      background-color: var(--secundaria);
      color: white;
    }
    
    .botao-secundaria:hover {
      background-color: #7d3c98;
      transform: translateY(-2px);
    }
    
    .botao-perigo {
      background-color: #dc3545;
      color: white;
    }
    
    .botao-perigo:hover {
      background-color: #c82333;
      transform: translateY(-2px);
    }
    
    .botao-pequeno {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    
    .badge-perigo {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .badge-info {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    
    .selecao-paciente {
      position: relative;
    }
    
    .lista-pacientes {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 0 0 6px 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    
    .lista-pacientes.mostrar {
      display: block;
    }
    
    .item-paciente {
      padding: 0.5rem;
      cursor: pointer;
    }
    
    .item-paciente:hover {
      background-color: #f5f5f5;
    }
    
    .dia-calendario.selecionado {
      background-color: var(--primaria);
      color: white;
      font-weight: bold;
    }
    
    .dia-calendario.com-agendamento {
      background-color: #e8f4f8;
      position: relative;
    }
    
    .dia-calendario.com-agendamento::after {
      content: '';
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      background-color: var(--primaria);
      border-radius: 50%;
    }
    
    .horario-disponivel {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }
    
    .horario-indisponivel {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
      cursor: not-allowed;
    }
    
    .carregando {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <nav class="navegacao-superior">
    <div class="container-navegacao">
      <div class="logo">√Årea do Enfermeiro</div>
      
      <ul class="menu-navegacao">
        <li class="item-navegacao"><a href="/enfermeiro/dashboard" class="link-navegacao"><i class="fas fa-home"></i> In√≠cio</a></li>
        <li class="item-navegacao"><a href="/enfermeiro/nova-ficha" class="link-navegacao"><i class="fas fa-file-medical"></i> Fichas</a></li>
        <li class="item-navegacao"><a href="/enfermeiro/consultar" class="link-navegacao"><i class="fas fa-search"></i> Consultar</a></li>
        <li class="item-navegacao"><a href="/enfermeiro/agendamentos" class="link-navegacao ativo"><i class="fas fa-calendar-check"></i> Agendamentos</a></li>
        <li class="item-navegacao"><a href="/enfermeiro/relatorios" class="link-navegacao"><i class="fas fa-chart-bar"></i> Relat√≥rios</a></li>
      </ul>
      
      <div class="info-usuario">
        <img src="https://cdn-icons-png.flaticon.com/512/15181/15181334.png" class="avatar-usuario" alt="Avatar do usu√°rio">
        <span>{{.Enfermeiro.Name}}</span>
        
        <div class="menu-usuario">
          <a href="/medico/perfil"><i class="fas fa-user"></i> Meu Perfil</a>
          <a href="/medico/configuracoes"><i class="fas fa-cog"></i> Configura√ß√µes</a>
          <a href="/logout"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </div>
      </div>
    </div>
  </nav>

  <main class="conteudo-principal">
    <div class="cabecalho">
      <h1 class="titulo-pagina">Gest√£o de Agendamentos</h1>
      <button class="botao botao-primaria" onclick="abrirModalNovoAgendamento()">
        <i class="fas fa-plus"></i> Novo Agendamento
      </button>
    </div>

    <div class="container-calendario">
      <div class="cabecalho-calendario">
        <h2 id="mesAnoCalendario">Novembro 2023</h2>
        <div class="navegacao-calendario">
          <button id="btnMesAnterior"><i class="fas fa-chevron-left"></i></button>
          <button id="btnMesSeguinte"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      
      <div class="grade-calendario" id="gradeCalendario">
        <!-- Dias ser√£o preenchidos via JavaScript -->
      </div>
    </div>

    <div class="lista-agendamentos">
      <h2 id="tituloAgendamentosDia">Agendamentos para Hoje (<span id="dataAtual">15/11/2023</span>)</h2>
      <div id="listaAgendamentos">
        <!-- Agendamentos ser√£o carregados via JavaScript -->
      </div>
    </div>
  </main>
  
  <div class="modal" id="modalAgendamento">
    <div class="conteudo-modal">
      <span class="fechar">&times;</span>
      <h2>Novo Agendamento</h2>
      <form id="formularioAgendamento">
        <div class="grupo-formulario selecao-paciente">
          <label>Paciente</label>
          <input type="text" id="inputPaciente" class="controle-formulario" required placeholder="Digite o nome ou CNS do paciente">
          <div class="lista-pacientes" id="listaPacientes"></div>
        </div>
        
        <input type="hidden" id="pacienteId">
        
        <div class="grupo-formulario">
          <label>Tipo de Consulta</label>
          <select id="tipoConsulta" class="controle-formulario" required>
            <option value="">Selecione...</option>
            <option value="Preventivo">Preventivo</option>
            <option value="Retorno">Retorno</option>
            <option value="Curativo">Curativo</option>
            <option value="Vacina√ß√£o">Vacina√ß√£o</option>
            <option value="Medica√ß√£o">Medica√ß√£o</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        
        <div class="linha-formulario">
          <div class="grupo-formulario">
            <label>Data</label>
            <input type="date" id="dataAgendamento" class="controle-formulario" required>
          </div>
          <div class="grupo-formulario">
            <label>Hor√°rio</label>
            <select id="horarioAgendamento" class="controle-formulario" required>
              <option value="">Selecione...</option>
              <!-- Hor√°rios ser√£o preenchidos via JavaScript -->
            </select>
          </div>
        </div>

        <div class="grupo-formulario">
          <label>Observa√ß√µes</label>
          <textarea id="observacoes" class="controle-formulario" rows="3"></textarea>
        </div>

        <button type="submit" class="botao botao-primaria" id="btnAgendar">
          <span id="textoBtnAgendar">Agendar</span>
          <span id="carregandoBtnAgendar" class="carregando" style="display: none;"></span>
        </button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalConfirmacao">
    <div class="conteudo-modal">
      <span class="fechar">&times;</span>
      <h2 id="tituloModalConfirmacao">Confirmar A√ß√£o</h2>
      <p id="mensagemModalConfirmacao">Tem certeza que deseja realizar esta a√ß√£o?</p>
      <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
        <button class="botao botao-secundaria" id="btnConfirmarAcao">Confirmar</button>
        <button class="botao botao-perigo" onclick="fecharModalConfirmacao()">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    // Vari√°veis globais
    let dataAtual = new Date();
    let agendamentos = [];
    let pacienteSelecionado = null;
    let agendamentoParaAcao = null;
    
    // Elementos do DOM
    const mesAnoCalendario = document.getElementById('mesAnoCalendario');
    const gradeCalendario = document.getElementById('gradeCalendario');
    const tituloAgendamentosDia = document.getElementById('tituloAgendamentosDia');
    const dataAtualSpan = document.getElementById('dataAtual');
    const listaAgendamentos = document.getElementById('listaAgendamentos');
    const modalAgendamento = document.getElementById('modalAgendamento');
    const modalConfirmacao = document.getElementById('modalConfirmacao');
    const formularioAgendamento = document.getElementById('formularioAgendamento');
    const inputPaciente = document.getElementById('inputPaciente');
    const listaPacientes = document.getElementById('listaPacientes');
    const pacienteId = document.getElementById('pacienteId');
    const tipoConsulta = document.getElementById('tipoConsulta');
    const dataAgendamento = document.getElementById('dataAgendamento');
    const horarioAgendamento = document.getElementById('horarioAgendamento');
    const observacoes = document.getElementById('observacoes');
    const btnAgendar = document.getElementById('btnAgendar');
    const textoBtnAgendar = document.getElementById('textoBtnAgendar');
    const carregandoBtnAgendar = document.getElementById('carregandoBtnAgendar');
    const btnMesAnterior = document.getElementById('btnMesAnterior');
    const btnMesSeguinte = document.getElementById('btnMesSeguinte');
    const btnConfirmarAcao = document.getElementById('btnConfirmarAcao');
    
    // Fun√ß√µes para manipula√ß√£o de datas
    function formatarData(data) {
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }
    
    function formatarDataParaAPI(data) {
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      return `${ano}-${mes}-${dia}`;
    }
    
    function formatarHoraParaAPI(hora) {
      return `${hora}:00`;
    }
    
    function obterNomeMes(mes) {
      const meses = [
        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      return meses[mes];
    }
    
    // Fun√ß√µes para carregar dados
    async function carregarAgendamentos(data) {
      try {
        const response = await fetch(`/enfermeiro/agendamentos/listar?date=${formatarDataParaAPI(data)}`);
        if (!response.ok) throw new Error('Erro ao carregar agendamentos');
        
        const dados = await response.json();
        agendamentos = dados.agendamentos || [];
        console.log(dados);
        
        // Atualizar a exibi√ß√£o
        dataAtualSpan.textContent = dados.data;
        atualizarListaAgendamentos();
      } catch (erro) {
        console.error('Erro:', erro);
        alert('N√£o foi poss√≠vel carregar os agendamentos. Tente novamente.');
      }
    }
    
    async function buscarPacientes(termo) {
      try {
        const response = await fetch(`/buscar-paciente?q=${termo}`);
        if (!response.ok) throw new Error('Erro ao buscar pacientes');
        
        return await response.json();
      } catch (erro) {
        console.error('Erro:', erro);
        return [];
      }
    }
    
    // Fun√ß√µes para renderiza√ß√£o
    function atualizarListaAgendamentos() {
      if (agendamentos.length === 0) {
        listaAgendamentos.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #666;">
            <i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Nenhum agendamento para esta data</p>
          </div>
        `;
        return;
      }
      
      listaAgendamentos.innerHTML = agendamentos.map(agendamento => `
        <div class="item-agendamento" data-id="${agendamento.id}">
          <div>
            <strong>${agendamento.paciente_nome}</strong>
            <div>${formatarHoraAgendamento(agendamento.data_hora)} - ${agendamento.tipo_consulta}</div>
            <span class="badge ${obterClasseStatus(agendamento.status)}">${formatarStatus(agendamento.status)}</span>
          </div>
          <div class="acoes-agendamento">
            ${agendamento.status === 'pendente' || agendamento.status === 'confirmado' ? `
              <button class="botao botao-secundaria botao-pequeno" onclick="abrirModalConfirmacao('confirmar', '${agendamento.id}')">
                <i class="fas fa-check"></i>
              </button>
              <button class="botao botao-perigo botao-pequeno" onclick="abrirModalConfirmacao('cancelar', '${agendamento.id}')">
                <i class="fas fa-times"></i>
              </button>
            ` : ''}
            ${agendamento.status === 'confirmado' ? `
              <button class="botao botao-primaria botao-pequeno" onclick="abrirModalConfirmacao('concluir', '${agendamento.id}')">
                <i class="fas fa-check-circle"></i>
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }
    
    function formatarHoraAgendamento(dataHora) {
      const data = new Date(dataHora);
      const horas = String(data.getHours()).padStart(2, '0');
      const minutos = String(data.getMinutes()).padStart(2, '0');
      return `${horas}:${minutos}`;
    }
    
    function formatarStatus(status) {
      const statusMap = {
        'pendente': 'Pendente',
        'confirmado': 'Confirmado',
        'cancelado': 'Cancelado',
        'concluido': 'Conclu√≠do'
      };
      return statusMap[status] || status;
    }
    
    function obterClasseStatus(status) {
      const classesMap = {
        'pendente': 'badge-alerta',
        'confirmado': 'badge-sucesso',
        'cancelado': 'badge-perigo',
        'concluido': 'badge-info'
      };
      return classesMap[status] || '';
    }
    
    function renderizarCalendario(ano, mes) {
      // Limpar calend√°rio
      gradeCalendario.innerHTML = '';
      
      // Adicionar cabe√ßalhos dos dias da semana
      const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
      diasSemana.forEach(dia => {
        const divDia = document.createElement('div');
        divDia.className = 'dia-calendario cabecalho';
        divDia.textContent = dia;
        gradeCalendario.appendChild(divDia);
      });
      
      // Obter primeiro dia do m√™s e √∫ltimo dia do m√™s
      const primeiroDia = new Date(ano, mes, 1);
      const ultimoDia = new Date(ano, mes + 1, 0);
      
      // Obter dia da semana do primeiro dia (0-6)
      const diaSemanaPrimeiroDia = primeiroDia.getDay();
      
      // Obter √∫ltimo dia do m√™s anterior
      const ultimoDiaMesAnterior = new Date(ano, mes, 0).getDate();
      
      // Adicionar dias do m√™s anterior (se necess√°rio)
      for (let i = diaSemanaPrimeiroDia - 1; i >= 0; i--) {
        const divDia = document.createElement('div');
        divDia.className = 'dia-calendario';
        divDia.textContent = ultimoDiaMesAnterior - i;
        divDia.style.color = '#ccc';
        gradeCalendario.appendChild(divDia);
      }
      
      // Adicionar dias do m√™s atual
      for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const divDia = document.createElement('div');
        divDia.className = 'dia-calendario';
        divDia.textContent = dia;
        
        // Verificar se h√° agendamentos neste dia
        const dataDia = new Date(ano, mes, dia);
        const temAgendamento = agendamentos.some(ag => {
          const dataAg = new Date(ag.data_hora);
          return dataAg.getDate() === dataDia.getDate() && 
                 dataAg.getMonth() === dataDia.getMonth() && 
                 dataAg.getFullYear() === dataDia.getFullYear();
        });
        
        if (temAgendamento) {
          divDia.classList.add('com-agendamento');
        }
        
        // Destacar dia atual
        const hoje = new Date();
        if (dia === hoje.getDate() && mes === hoje.getMonth() && ano === hoje.getFullYear()) {
          divDia.classList.add('selecionado');
        }
        
        // Adicionar evento de clique
        divDia.addEventListener('click', () => {
          selecionarDiaCalendario(dia, mes, ano);
        });
        
        gradeCalendario.appendChild(divDia);
      }
      
      // Adicionar dias do pr√≥ximo m√™s (se necess√°rio)
      const diasRestantes = 42 - (diaSemanaPrimeiroDia + ultimoDia.getDate());
      for (let dia = 1; dia <= diasRestantes; dia++) {
        const divDia = document.createElement('div');
        divDia.className = 'dia-calendario';
        divDia.textContent = dia;
        divDia.style.color = '#ccc';
        gradeCalendario.appendChild(divDia);
      }
      
      // Atualizar t√≠tulo do calend√°rio
      mesAnoCalendario.textContent = `${obterNomeMes(mes)} ${ano}`;
    }
    
    function selecionarDiaCalendario(dia, mes, ano) {
      // Remover sele√ß√£o anterior
      const diasSelecionados = document.querySelectorAll('.dia-calendario.selecionado');
      diasSelecionados.forEach(d => d.classList.remove('selecionado'));
      
      // Adicionar sele√ß√£o ao dia clicado
      const dias = document.querySelectorAll('.dia-calendario');
      const diaSelecionado = Array.from(dias).find(d => 
        d.textContent === String(dia) && !d.classList.contains('cabecalho') && d.style.color !== 'rgb(204, 204, 204)'
      );
      
      if (diaSelecionado) {
        diaSelecionado.classList.add('selecionado');
        const dataSelecionada = new Date(ano, mes, dia);
        carregarAgendamentos(dataSelecionada);
      }
    }
    
    function carregarHorariosDisponiveis(data) {
      // Simula√ß√£o - na pr√°tica, voc√™ faria uma chamada API para verificar hor√°rios dispon√≠veis
      const horarios = [];
      const horaInicio = 8;
      const horaFim = 17;
      
      for (let hora = horaInicio; hora <= horaFim; hora++) {
        // Adiciona hor√°rios de hora em hora e meia em meia hora
        horarios.push(`${String(hora).padStart(2, '0')}:00`);
        if (hora < horaFim) {
          horarios.push(`${String(hora).padStart(2, '0')}:30`);
        }
      }
      
      // Limpar select
      horarioAgendamento.innerHTML = '<option value="">Selecione...</option>';
      
      // Adicionar hor√°rios dispon√≠veis
      horarios.forEach(horario => {
        const option = document.createElement('option');
        option.value = horario;
        option.textContent = horario;
        horarioAgendamento.appendChild(option);
      });
    }
    
    // Fun√ß√µes para modais
    function abrirModalNovoAgendamento() {
      // Definir data m√≠nima como hoje
      const hoje = new Date();
      dataAgendamento.min = formatarDataParaAPI(hoje);
      dataAgendamento.value = formatarDataParaAPI(hoje);
      
      // Carregar hor√°rios dispon√≠veis para hoje
      carregarHorariosDisponiveis(hoje);
      
      // Limpar formul√°rio
      formularioAgendamento.reset();
      pacienteId.value = '';
      pacienteSelecionado = null;
      
      // Abrir modal
      modalAgendamento.style.display = 'block';
    }
    
    function fecharModalAgendamento() {
      modalAgendamento.style.display = 'none';
    }
    
    function abrirModalConfirmacao(acao, agendamentoId) {
      agendamentoParaAcao = agendamentoId;
      
      const titulo = document.getElementById('tituloModalConfirmacao');
      const mensagem = document.getElementById('mensagemModalConfirmacao');
      
      if (acao === 'confirmar') {
        titulo.textContent = 'Confirmar Agendamento';
        mensagem.textContent = 'Tem certeza que deseja confirmar este agendamento?';
        btnConfirmarAcao.className = 'botao botao-secundaria';
        btnConfirmarAcao.innerHTML = '<i class="fas fa-check"></i> Confirmar';
        btnConfirmarAcao.onclick = () => atualizarStatusAgendamento('confirmado');
      } else if (acao === 'cancelar') {
        titulo.textContent = 'Cancelar Agendamento';
        mensagem.textContent = 'Tem certeza que deseja cancelar este agendamento?';
        btnConfirmarAcao.className = 'botao botao-perigo';
        btnConfirmarAcao.innerHTML = '<i class="fas fa-times"></i> Cancelar';
        btnConfirmarAcao.onclick = () => atualizarStatusAgendamento('cancelado');
      } else if (acao === 'concluir') {
        titulo.textContent = 'Concluir Agendamento';
        mensagem.textContent = 'Tem certeza que deseja marcar este agendamento como conclu√≠do?';
        btnConfirmarAcao.className = 'botao botao-primaria';
        btnConfirmarAcao.innerHTML = '<i class="fas fa-check-circle"></i> Concluir';
        btnConfirmarAcao.onclick = () => atualizarStatusAgendamento('concluido');
      }
      
      modalConfirmacao.style.display = 'block';
    }
    
    function fecharModalConfirmacao() {
      modalConfirmacao.style.display = 'none';
      agendamentoParaAcao = null;
    }
    
    // Fun√ß√µes para manipula√ß√£o de agendamentos
    async function criarAgendamento() {
      const dados = {
        paciente_id: pacienteId.value,
        tipo_consulta: tipoConsulta.value,
        data_hora: `${dataAgendamento.value}T${horarioAgendamento.value}:00`,
        observacoes: observacoes.value
      };
      
      try {
        // Mostrar indicador de carregamento
        textoBtnAgendar.style.display = 'none';
        carregandoBtnAgendar.style.display = 'inline-block';
        
        const response = await fetch('/enfermeiro/agendamentos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(dados)
        });
        
        if (!response.ok) throw new Error('Erro ao criar agendamento');
        
        const novoAgendamento = await response.json();
        
        // Recarregar agendamentos para a data selecionada
        const dataSelecionada = new Date(dataAgendamento.value);
        await carregarAgendamentos(dataSelecionada);
        
        // Fechar modal e limpar formul√°rio
        fecharModalAgendamento();
        formularioAgendamento.reset();
        
        // Mostrar mensagem de sucesso
        alert('Agendamento criado com sucesso!');
      } catch (erro) {
        console.error('Erro:', erro);
        alert('N√£o foi poss√≠vel criar o agendamento. Verifique os dados e tente novamente.');
      } finally {
        // Restaurar bot√£o
        textoBtnAgendar.style.display = 'inline';
        carregandoBtnAgendar.style.display = 'none';
      }
    }
    
    async function atualizarStatusAgendamento(novoStatus) {
      try {
        const response = await fetch(`/enfermeiro/agendamentos/${agendamentoParaAcao}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: novoStatus })
        });
        
        if (!response.ok) throw new Error('Erro ao atualizar agendamento');
        
        // Recarregar agendamentos para a data atual
        await carregarAgendamentos(dataAtual);
        
        // Fechar modal de confirma√ß√£o
        fecharModalConfirmacao();
        
        // Mostrar mensagem de sucesso
        alert('Agendamento atualizado com sucesso!');
      } catch (erro) {
        console.error('Erro:', erro);
        alert('N√£o foi poss√≠vel atualizar o agendamento. Tente novamente.');
      }
    }
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Inicializar calend√°rio
      renderizarCalendario(dataAtual.getFullYear(), dataAtual.getMonth());
      
      // Carregar agendamentos para hoje
      carregarAgendamentos(dataAtual);
      
      // Configurar evento de mudan√ßa de m√™s
      btnMesAnterior.addEventListener('click', () => {
        dataAtual.setMonth(dataAtual.getMonth() - 1);
        renderizarCalendario(dataAtual.getFullYear(), dataAtual.getMonth());
      });
      
      btnMesSeguinte.addEventListener('click', () => {
        dataAtual.setMonth(dataAtual.getMonth() + 1);
        renderizarCalendario(dataAtual.getFullYear(), dataAtual.getMonth());
      });
      
      // Configurar busca de pacientes
      inputPaciente.addEventListener('input', async (e) => {
        const termo = e.target.value.trim();
        
        if (termo.length < 3) {
          listaPacientes.classList.remove('mostrar');
          return;
        }
        
        const pacientes = await buscarPacientes(termo);
        
        if (pacientes.length > 0) {
          listaPacientes.innerHTML = pacientes.map(paciente => `
            <div class="item-paciente" data-id="${paciente.id}" data-nome="${paciente.nome}">
              ${paciente.nome} - ${paciente.cns}
            </div>
          `).join('');
          
          // Adicionar eventos de clique aos itens
          document.querySelectorAll('.item-paciente').forEach(item => {
            item.addEventListener('click', () => {
              pacienteSelecionado = {
                id: item.dataset.id,
                nome: item.dataset.nome
              };
              
              inputPaciente.value = pacienteSelecionado.nome;
              pacienteId.value = pacienteSelecionado.id;
              listaPacientes.classList.remove('mostrar');
            });
          });
          
          listaPacientes.classList.add('mostrar');
        } else {
          listaPacientes.innerHTML = '<div class="item-paciente">Nenhum paciente encontrado</div>';
          listaPacientes.classList.add('mostrar');
        }
      });
      
      // Fechar lista de pacientes ao clicar fora
      document.addEventListener('click', (e) => {
        if (!inputPaciente.contains(e.target)) {
          listaPacientes.classList.remove('mostrar');
        }
      });
      
      // Configurar mudan√ßa de data no formul√°rio
      dataAgendamento.addEventListener('change', (e) => {
        const dataSelecionada = new Date(e.target.value);
        carregarHorariosDisponiveis(dataSelecionada);
      });
      
      // Configurar envio do formul√°rio
      formularioAgendamento.addEventListener('submit', (e) => {
        e.preventDefault();
        criarAgendamento();
      });
    });
    
    // Fechar modais ao clicar no X ou fora
    document.querySelectorAll('.fechar').forEach(btn => {
      btn.addEventListener('click', () => {
        modalAgendamento.style.display = 'none';
        modalConfirmacao.style.display = 'none';
      });
    });
    
    window.addEventListener('click', (e) => {
      if (e.target === modalAgendamento) {
        modalAgendamento.style.display = 'none';
      }
      if (e.target === modalConfirmacao) {
        modalConfirmacao.style.display = 'none';
      }
    });
  </script>
</body>
</html>